name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest

    # Only deploy on main branch
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            # Navigate to app directory
            cd /opt/climate-data-explorer || {
              echo "âŒ Directory not found, cloning repository..."
              sudo mkdir -p /opt
              cd /opt
              sudo git clone https://github.com/${{ github.repository }}.git climate-data-explorer
              cd climate-data-explorer
            }

            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            sudo git fetch origin
            sudo git reset --hard origin/main
            sudo git clean -fd

            # Set environment variables
            export GROK_API_KEY="${{ secrets.GROK_API_KEY }}"

            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            sudo docker-compose down || true

            # Build and start new containers
            echo "ğŸ”¨ Building and starting containers..."
            sudo docker-compose build --no-cache
            sudo docker-compose up -d

            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 10

            # Health check
            echo "ğŸ¥ Checking health..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Backend is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ Backend health check failed"
                sudo docker-compose logs backend
                exit 1
              fi
              sleep 2
            done

            # Clean up old images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f

            echo "âœ… Deployment complete!"

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 5

          # Get EC2 host from secrets
          EC2_HOST="${{ secrets.AWS_EC2_HOST }}"

          # Check backend health
          if curl -f http://${EC2_HOST}/api/v1/health; then
            echo "âœ… Backend is responding!"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi

          # Check frontend
          if curl -f http://${EC2_HOST}/; then
            echo "âœ… Frontend is responding!"
          else
            echo "âŒ Frontend check failed"
            exit 1
          fi

          echo "ğŸ‰ Deployment verified successfully!"
